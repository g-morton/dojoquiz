<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dojo Quiz</title>
  <style>
    html, body { height: 100%; margin: 0; font-size:large;}
    body { display: flex; align-items: center; justify-content: center; font-family: sans-serif; background: linear-gradient(to bottom, #0a1a3a, #000); color: #fff; text-align: center; }
    #startBtn, #qbox, #answers button { background: #0a1a3a; border: 2px solid #fff; color: #fff; font-weight: bold; padding: 16px; margin: 8px; font-size: large; }
    #answers { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    #ranks {font-size: larger;margin: auto;max-width: 50%;}
    #ranks div {
        font-weight: bold;
        padding: 5px;
        border: 2px solid grey;
        border-radius: 20px;
        margin-bottom: 10px;
    }
    #splashScreen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    #splashScreen img {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
    }
    #splashScreen button {
      margin-top: 20px;
    }

    #credits {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
      padding: 24px;
    }
    #credits img {
      max-width: 90vw;
      max-height: 80vh;
      object-fit: contain;
      border: 4px solid #fff;
    }
    #credits button,
    #credits a {
      background: #0a1a3a;
      border: 4px solid #fff;
      color: #fff;
      font-weight: bold;
      padding: 10px 16px;
      text-decoration: none;
    }

  </style>
</head>
<body>
<div id="app" style="width:80%"></div>
<audio id="suspense" src="suspense.mp3" loop></audio>
<audio id="lockin" src="lockin.mp3" loop></audio>
<audio id="correct" src="correct.mp3"></audio>
<audio id="wrong" src="wrong.mp3"></audio>
<script>
let questions = [];
let ladder = [];
let idx = 0, score = 0, sel = null, rev = false;
const app = document.getElementById('app');

function playSuspense(){ const a=document.getElementById('suspense'); a.pause(); a.currentTime=0; a.loop=true; a.play(); }
function stopSuspense(){ const a=document.getElementById('suspense'); a.pause(); a.currentTime=0; a.loop=false; }
function playLock(){ const a=document.getElementById('lockin'); a.pause(); a.currentTime=0; a.loop=true; a.play(); }
function stopLock(){ const a=document.getElementById('lockin'); a.pause(); a.currentTime=0; }
function playReveal(){ const id = sel===questions[idx].correct - 1 ? 'correct' : 'wrong'; document.getElementById(id).play(); }

function showStart(){
  app.innerHTML = `
    <div id="splashScreen">
      <img src="dojoquiz.png" alt="Splash Image">
      <button id="startBtn">Start game</button>
    </div>`;
  document.getElementById('startBtn').onclick = () => { 
    idx = 0; score = 0; sel = null; rev = false; 
    render(); 
  };
}

function displayQuestion(){
  const q = questions[idx];
  const currentRank = score > 0 ? ladder[score-1] : null;
  const targetRank = ladder[Math.min(score, ladder.length-1)];
  if(sel === null){ stopLock(); stopSuspense(); playSuspense(); }
  let ranksHTML = '';
  if(score === 0){
    ranksHTML = `<div style="border-color: grey">${targetRank}</div>`;
  } else if(score < ladder.length){
    ranksHTML = `<div style="border-color: grey">${score}. ${currentRank}</div> <div style="color:goldenrod ; border-color: goldenrod">${score + 1}. ${targetRank}</div>`;
  } else {
    ranksHTML = `<div style="color:goldenrod ; border-color: goldenrod">${currentRank}</div>`;
  }
  app.innerHTML = `
  <div id="qbox">${q.q}</div>
  <div id="answers"></div>
  <p style="opacity:0.5; margin-bottom: 20px">${!sel ? 'Lock in an answer' : !rev ? 'Click to reveal' : 'Click to continue'}</p>  
  <div id="ranks">${ranksHTML}</div>
  <p><a href="#" id="creditsLink">Credits</a></p>
  `;
  const creditsLink = document.getElementById('creditsLink');
  creditsLink.onclick = (e) => {
    e.preventDefault();
    e.stopPropagation(); // donâ€™t trigger reveal
    showCredits();
  };
  const aDiv = document.getElementById('answers');
  q.a.forEach((t,i)=>{
    const b = document.createElement('button');
    b.textContent = String.fromCharCode(65+i)+'. '+t;
    b.style.border = sel===i ? '2px solid goldenrod' : '2px solid white';
    b.style.background = rev && i===q.correct - 1 ? 'green' : '#0a1a3a';
    b.onclick = e => {
      e.stopPropagation(); if(sel!==null) return;
      sel=i; stopSuspense(); playLock(); render();
    };
    aDiv.appendChild(b);
  });
}

function endScreen(){
  stopSuspense(); stopLock();
  app.innerHTML=`<div id="ranks">
  <h1>${score}/${questions.length}</h1>
  <p>You are awarded</p>
  <div style="color:goldenrod ; border-color: goldenrod">${ladder[score-1]||ladder[0]}</div>
  <br/><br/>
  <p>Click to restart</p>
  `;
  app.onclick=()=>{ idx=0; score=0; sel=null; rev=false; showStart(); };
}

function showCredits(){
  stopSuspense();
  stopLock();
  app.onclick = null;
  app.innerHTML = `
    <div id="credits">
      <img src="group-photo.png" alt="Team photo">
      <button id="backBtn">Back</button>
    </div>
  `;
  document.getElementById('backBtn').onclick = (e) => {
    e.stopPropagation();
    render();
  };
}

function render(){
  if(idx>=questions.length){ endScreen(); return; }
  displayQuestion();
  app.onclick = () => {
    if(sel === null) return;
    stopLock();
    if(!rev){ rev=true; playReveal(); if(sel===questions[idx].correct - 1) score++; render(); }
    else { idx++; sel=null; rev=false; render(); }
  };
}

async function init() {
  try {
    console.info("Init");
    const [qRes, lRes] = await Promise.all([
      fetch('questions.json'),
      fetch('ladder.json')
    ]);
    if (!qRes.ok || !lRes.ok) throw new Error('Failed to fetch data');
    questions = await qRes.json();
    ladder = await lRes.json();
    console.info("Show start");
    showStart();
  } catch (err) {
    app.innerHTML = `<p>Could not load quiz data. Please check questions.json and ladder.json.</p>`;
    console.error(err);
  }
}
init();

</script>
</body>
</html>
