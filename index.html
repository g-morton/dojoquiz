<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dojo Quiz</title>
  <style>
    html, body { height: 100%; margin: 0; font-size:large;}
    body { display: flex; align-items: center; justify-content: center; font-family: sans-serif; background: linear-gradient(to bottom, #0a1a3a, #000); color: #fff; text-align: center; }
    #startBtn, #qbox, #answers button { background: #0a1a3a; border: 2px solid #fff; color: #fff; font-weight: bold; padding: 16px; margin: 8px; font-size: large; }
    #answers { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  </style>
</head>
<body>
<div id="app" style="width:80%"></div>
<audio id="suspense" src="suspense.mp3" loop></audio>
<audio id="lockin" src="lockin.mp3" loop></audio>
<audio id="correct" src="correct.mp3"></audio>
<audio id="wrong" src="wrong.mp3"></audio>
<script>
let questions = [];
let ladder = [];
  
let idx = 0, score = 0, sel = null, rev = false;
const app = document.getElementById('app');

function playSuspense(){ const a=document.getElementById('suspense'); a.pause(); a.currentTime=0; a.loop=true; a.play(); }
function stopSuspense(){ const a=document.getElementById('suspense'); a.pause(); a.currentTime=0; a.loop=false; }
function playLock(){ const a=document.getElementById('lockin'); a.pause(); a.currentTime=0; a.loop=true; a.play(); }
function stopLock(){ const a=document.getElementById('lockin'); a.pause(); a.currentTime=0; }
function playReveal(){ const id = sel===questions[idx].correct - 1 ? 'correct' : 'wrong'; document.getElementById(id).play(); }

function showStart(){
  app.innerHTML = '<h1>Who wants to be a Dojo Master?</h1><button id="startBtn">Start a new game</button>';
  document.getElementById('startBtn').onclick = () => { idx=0;score=0;sel=null;rev=false; render(); };
}

function displayQuestion(){
  const q = questions[idx];
  const currentRank = score > 0 ? ladder[score-1] : null;
  const targetRank = ladder[Math.min(score, ladder.length-1)];
  if(sel === null){ stopLock(); stopSuspense(); playSuspense(); }
  //app.innerHTML = `<div id='qbox'>${q.q}</div><div id='answers'></div><p>${!sel?'Lock in an answer':!rev?'Click to reveal':'Click to continue'}</p>`;
  
  let ranksHTML = '';
  if(score === 0){
    ranksHTML = `<div>You are now playing for <b>${targetRank}</b></div>`;
  } else if(score < ladder.length){
    ranksHTML = `<div>You are <b>${score}.  ${currentRank}</b></div><div>Now playing for <b>${score + 1}.  ${targetRank}</b></div>`;
  } else {
    ranksHTML = `<div>You've achieved top rank of <b>${currentRank}</b></div>`;
  }

  app.innerHTML = `
  <div id="qbox">${q.q}</div>
  <div id="answers"></div>
  <div id="ranks">${ranksHTML}</div>
  <p>${!sel ? 'Lock in an answer' : !rev ? 'Click to reveal' : 'Click to continue'}</p>
  `;

  const aDiv = document.getElementById('answers');
  q.a.forEach((t,i)=>{
    const b = document.createElement('button');
    b.textContent = String.fromCharCode(65+i)+'. '+t;
    b.style.border = sel===i ? '2px solid orange' : '2px solid white';
    b.style.background = rev && i===q.correct - 1 ? 'green' : '#0a1a3a';
    b.onclick = e => {
      e.stopPropagation(); if(sel!==null) return;
      sel=i; stopSuspense(); playLock(); render();
    };
    aDiv.appendChild(b);
  });
}

function endScreen(){
  stopSuspense(); stopLock();
  app.innerHTML=`<h1>Score: ${score}/${questions.length}</h1><p>You are awarded<h2>${ladder[score-1]||ladder[0]}</h2><br/><br/><p>Click to restart</p>`;
  app.onclick=()=>{ idx=0; score=0; sel=null; rev=false; showStart(); };
}

function render(){
  if(idx>=questions.length){ endScreen(); return; }
  displayQuestion();
  app.onclick = () => {
    if(sel === null) return;
    stopLock();
    if(!rev){ rev=true; playReveal(); if(sel===questions[idx].correct - 1) score++; render(); }
    else { idx++; sel=null; rev=false; render(); }
  };
}

async function init() {
  try {
    console.info("Init");
    const [qRes, lRes] = await Promise.all([
      fetch('questions.json'),
      fetch('ladder.json')
    ]);
    if (!qRes.ok || !lRes.ok) throw new Error('Failed to fetch data');
    questions = await qRes.json();
    ladder = await lRes.json();
    console.info("Show start");
    showStart();
  } catch (err) {
    app.innerHTML = `<p>Could not load quiz data. Please check questions.json and ladder.json.</p>`;
    console.error(err);
  }
}
init();

</script>
</body>
</html>
